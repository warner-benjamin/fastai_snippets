name: 'nbdev CI'
on: [workflow_dispatch, push, pull_request]
  inputs:
    pre:
      description: 'Install prerelease nbdev/execnb from master?'
      required: false
      default: ''
    version:
      description: 'Version of python to use'
      required: false
      default: '3.7'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Set up python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ inputs.version }}
        architecture: 'x64'
  
    - name: Activate python cache
      uses: actions/cache@v3
      env:
        cache-name: pip-packages
      with:
        path: |
          ${{ env.pythonLocation }}
          ${{ env.pip-packages }}
        key: ${{ env.pythonLocation }}-${{ hashFiles('setup.py') }}

    - name: Install the library
      run: |
        sudo apt-get install libsndfile1-dev
        pip install --upgrade pip
        if [ $USE_PRE ]; then
          pip install -U git+https://github.com/fastai/fastcore.git
          pip install -U git+https://github.com/fastai/ghapi.git
          pip install -U git+https://github.com/fastai/execnb.git
          pip install -U git+https://github.com/fastai/nbdev.git
        fi
        pip install -e .[dev]

    - name: Check that notebooks are clean
      run: |
        nbdev_clean
        git status -s # display the status to see which nbs need cleaning up
        if [[ `git status --porcelain -uno` ]]; then
          git status -uno
          echo -e "!!! Detected unstripped out notebooks\n!!!Remember to run nbdev_install_hooks"
          false
        fi

    - name: Check that notebooks and library are in sync
      run: |
        nbdev_export
        if [[ `git status --porcelain -uno` ]]; then
          echo "::error::Notebooks and library are not in sync.  Please run nbdev_export."
          git status -uno
          git diff
          exit 1;
        fi

    - name: Run tests
      run: |
        nbdev_test